### Text-Simpler 仕様書（暫定版 v1.0）

- **製品名**: Text-Simpler  
- **目的**: Webページ上の文章を生成AIで変換し、理解容易性・抽象度・学年相当の読みやすさを制御して提示する  
- **対象ブラウザ**: Chrome (Manifest V3)  
- **対応言語**: 日本語（将来: 英語など拡張）

---

## 1. 背景とゴール

- **背景**: 専門的・抽象的・難解な文章がWeb上に多く、読者のレベルに合わせた再表現が困難。
- **ゴール**: 選択テキストまたはページ内テキストを「専門性を下げる」「抽象⇄具体」「学年レベル（小/中/高）」で適切に変換し、迅速・安全に表示。

---

## 2. スコープ

- **対象操作**: 選択テキストの変換、ページ内の段落単位変換、ポップアップUIからの操作、コンテキストメニュー、ショートカット。
- **対象出力**: 置換表示・並列表示・差分ハイライト表示（切替可能）。
- **非対象**: 長期保存・外部共有・アカウント機能（将来拡張）。

---

## 3. 用語

- **簡素化（専門性低下）**: 専門用語を平易語へ置き換え、構文を単純化。
- **具体化**: 抽象表現を具体例・手順・数値で補強。
- **抽象化**: 具体例から本質・共通構造へ一般化。
- **学年レベル**: 小学生／中学生／高校生相当の語彙・文長・構文制約。

---

## 4. ユースケース

- **専門記事を平易化**: 医療・法律記事を一般向け表現で素早く把握。
- **抽象記事を具体化**: コンセプトを具体例・ステップに落とす。
- **具体文を抽象化**: 本質・原理の把握・学習ノート化。
- **学年別読み替え**: 子どもへ説明、教育用途での段階的提示。

---

## 5. 機能要件（FRD）

- **FR-1 変換モード**
  - わかりやすく（専門性低下）
  - 具体化
  - 抽象化
  - 学年レベル: 小学生/中学生/高校生
- **FR-2 対象範囲**
  - 選択テキスト／ページ内テキスト（見出し・段落単位）
- **FR-3 表示**
  - 単独表示、原文との並列、差分ハイライト（単語・文単位）
- **FR-4 操作**
  - ポップアップ、コンテキストメニュー、ショートカット
- **FR-5 設定**
  - 生成AIプロバイダ/モデル/APIキー、温度、最大トークン
  - 出力形式（テキスト/JSON）、表示モード既定値、ストリーミングON/OFF
  - サイト許可/拒否リスト、送信前フィルタ（PII除去）
- **FR-6 変換精度ガード**
  - 事実の追加・捏造禁止の指示
  - 重要語の保持（固有名詞・数値）
  - 文長・語彙レベル制御
- **FR-7 大規模テキスト**
  - 段落チャンク分割、並列変換、結合整形
- **FR-8 失敗時ハンドリング**
  - エラー表示・リトライ・フォールバック（モデル変更/再試行）
- **FR-9 ローカル性**
  - ユーザテキストは外部保存しない（オプトインの一時キャッシュのみ）

---

## 6. 非機能要件（NFR）

- **NFR-1 レイテンシ**: 選択文（≤500字）でP50 ≤ 3s、P95 ≤ 8s（ネットワーク・モデル依存）
- **NFR-2 可用性**: 通信失敗時の明示・再試行案内
- **NFR-3 プライバシ**: 送信最小化、オプトインログ、PII除去オプション
- **NFR-4 UX**: ストリーミング進行表示、キャンセル、即時ロールバック
- **NFR-5 互換性**: Chrome 120+、Manifest V3
- **NFR-6 アクセシビリティ**: キーボード操作、コントラスト、フォントサイズ配慮

---

## 7. 画面/UX 仕様

- **ポップアップ**
  - モード選択（タブ/セグメント）
  - 学年レベル選択（小/中/高）
  - 対象: 選択／ページ全体（段落）
  - 変換実行、ストップ、表示モード切替（単独/並列/差分）
  - ストリーミング表示、コピー、元に戻す
- **オプション**
  - API設定（OpenAI/Gemini 等）、モデル、温度、トークン上限
  - 既定モード、表示モード、ストリーミング
  - サイト許可/拒否、PII除去、ログのオプトイン
- **ページ内UI**
  - 軽量オーバーレイ（右下等）
  - 変換結果カード（段落ごと）、差分ハイライト
  - 原文に戻す/置換適用
- **コンテキストメニュー**
  - “Text-Simplerで変換 → [モード/学年]”
- **ショートカット**
  - 例: Alt+S（簡素化）、Alt+A（抽象化）、Alt+C（具体化）、Alt+1/2/3（学年）

---

## 8. 変換モード仕様（プロンプト設計）

- **共通方針**
  - 事実を追加しない、曖昧な箇所は「不明」と明示
  - 固有名詞・数値・日付の保持
  - 出力は原文の意味保持を最優先
  - 文長・語彙をモードに応じて制御
- **出力形式**
  - 既定はプレーンテキスト
  - オプションでJSON（拡張）：{"mode","level","text"} を返す想定

- **プロンプト（例）**
  - 専門性を下げる:
    - システム: 「あなたは日本語のリライト支援AI。専門用語をやさしい言葉に置き換え、文を短くし、意味は変えない。事実の追加は禁止。固有名詞と数値は保持。」
    - ユーザー: 「以下の文章をわかりやすく書き直してください。出力は日本語の自然文のみ。\n---\n{テキスト}\n---」
  - 具体化:
    - システム: 「抽象概念を具体例・手順・数値目安で補う。ただし事実の追加は禁止。推定は『例』として明示。」
    - ユーザー: 「以下の文章を具体的に言い換え、例や手順を加えてください。意味は変えない。\n---\n{テキスト}\n---」
  - 抽象化:
    - システム: 「具体例から本質を抽出し一般化する。個別事例名は必要時のみ保持。」
    - ユーザー: 「以下の文章を抽象化し、原理や共通パターンを示してください。専門用語は最小限。\n---\n{テキスト}\n---」
  - 学年レベル（小/中/高）:
    - システム: 「日本語の文章を{レベル}向けに書き直す。平均文長と語彙レベルを制御。比喩は簡単に。事実の追加は禁止。」
    - ユーザー: 「以下の文章を{小学生/中学生/高校生}向けにリライトしてください。意味は変えない。\n---\n{テキスト}\n---」

- **語彙/文長の目安**
  - 小学生: 平均文長 ≤ 25文字、ひらがな多め、二重否定回避
  - 中学生: 平均文長 ≤ 35文字、基本語彙＋頻出専門語に簡単な注釈
  - 高校生: 平均文長 ≤ 45文字、論理接続明確、必要最小の専門語

---

## 9. アーキテクチャ

- **構成**: `background`（Service Worker）、`content`（DOM抽出/挿入）、`popup`（操作UI）、`options`（設定）、`api`（プロバイダ抽象化）
- **メッセージフロー**
  - content → background: {mode, level, chunks[]}
  - background → provider(API呼び出し) → content/popup（ストリーミング中継）
- **チャンク処理**
  - 段落単位で分割（目安: 300〜700文字/チャンク）
  - 並列度制限（例: 同時2〜3）、順序保持、最後に整形
- **ストレージ**
  - `chrome.storage.sync`/`local` にAPI設定、既定モード、UI設定、サイトポリシー
- **プロバイダ**
  - OpenAI/Geminiをプラガブルに。統一インターフェース: `transform({text, mode, level, params}) → {text}`
- **権限（manifest）**
  - "activeTab", "scripting", "storage", "contextMenus"
  - "host_permissions": ["<all_urls>"]（オプションで制限可）

---

## 10. データ/設定仕様（主要）

- **apiProvider**: "openai"|"gemini"
- **model**: 例 "gpt-4o-mini"|"gemini-1.5-pro"
- **temperature**: 0.0–1.0（既定0.3）
- **maxTokens**: 既定2,000（モデル上限に追従）
- **defaultMode**: "simplify"|"concretize"|"abstract"|"grade"
- **gradeLevel**: "elementary"|"junior"|"senior"
- **outputView**: "single"|"side-by-side"|"diff"
- **streaming**: boolean（既定ON）
- **filters**: { piiRedaction: boolean }
- **sitePolicy**: { allowlist: [], blocklist: [] }

---

## 11. エラー/リトライ

- **分類**: ネットワーク、認証、レート制限、長文超過、プロンプト違反
- **動作**:
  - 自動リトライ（指数バックオフ、最大2回）
  - モデル縮小やチャンク再分割の提案
  - 明確なユーザ向けメッセージ

---

## 12. パフォーマンス/コスト指針

- **ストリーミング優先**: 体感速度改善
- **チャンク並列**: 2–3並列、順序整合性を保持
- **キャッシュ**: 同一入力＋同一設定はセッション内キャッシュ（短期）
- **コスト**: 長文に警告、トークン見積もり表示（概算）

---

## 13. セキュリティ/プライバシ

- **送信最小化**: 選択テキスト優先、ページ全体でも範囲限定
- **PII除去オプション**: メール/電話/住所のマスキング（正規表現ベース）
- **ローカル保存**: 入力・出力は既定で保存しない
- **鍵管理**: APIキーは`chrome.storage`に保存、表示時は伏字

---

## 14. ロギング/計測（オプトイン）

- **匿名メトリクス**: 変換回数、平均レイテンシ、エラー率
- **デバッグ**: 開発者向けログ（UIトグル）

---

## 15. 品質基準/受け入れ基準

- **意味保持**: 重要情報（数値・固有名詞）一致率 ≥ 99%
- **可読性**: 学年レベルごとの文長・語彙制約を満たす
- **安定性**: P95エラー率 ≤ 2%（通信・配額除く）
- **UI**: ストリーミング提示、キャンセル、コピーが機能
- **テスト**
  - 単体: プロンプト生成・分割・結合・差分表示
  - 結合: 選択→変換→表示の一連
  - 回帰: 既知テキストの出力安定性チェック（目視＋LLM-as-a-judge）

---

## 16. 開発・実装方針（既存構成に沿った合理化）

- **ファイル構成（例）**
  - `manifest.json`: V3、権限、コマンド、サービスワーカー定義
  - `background.js`/`js/background.js`: リクエスト集約・API呼び出し・ストリーミング中継
  - `content.js`/`js/content.js`: DOM抽出/挿入、チャンク化、差分表示
  - `popup.js`/`html/popup.html`: UI操作、設定反映
  - `options.js`/`html/options.html`: API/既定値設定
  - `js/api/openai.js`・`js/api/gemini.js`: 統一IF `transform`
  - `js/utils/*`: storage, ui（差分・ハイライト）, errors
- **主要ロジック**
  - 選択取得→チャンク化→バックグラウンドへ→API→ストリーミング表示→結合→置換/並列/差分の各ビュー反映
- **将来互換**
  - モードの追加（例: 要約、語彙制限カスタム）
  - 多言語サポート

---

## 17. アクセシビリティ/国際化

- **配慮**: キーボード操作、メッセージ簡潔、色覚多様性
- **i18n**: 文言分離（将来の多言語化を見据え）

---

## 18. リリース計画（MVP→拡張）

- **MVP**: 簡素化/具体化/抽象化＋学年レベル、小規模テキスト、並列/差分表示、OpenAI/Geminiのどちらか1系
- **拡張**: JSON出力、評価メトリクス、許可/拒否リスト、PII除去、テレメトリ

---

## MVP実装仕様（Gemini固定）

### 1. スコープ（MVP）

- **対象テキスト**: 選択テキスト（Selection）を優先。ページ全体はβ（段落抽出は最小限）。
- **変換モード**: 簡素化（専門性低下）/ 具体化 / 抽象化 / 学年レベル（小・中・高）。
- **モデル**: Gemini 1.5 Pro 固定。ストリーミングなし（同期応答）。
- **UI**: ポップアップ（必須）、オプションページ（APIキー/既定値設定）。
- **表示**: 変換テキストの単独表示＋コピー。並列表示/差分表示は任意（Nice to have）。
- **保存**: 変換結果は保存しない。APIキーのみ`chrome.storage`に保存。

### 2. 画面/操作（MVP）

- **ポップアップ**
  - モード選択（タブ/セグメント）
  - 学年レベル選択（小/中/高）
  - 「選択テキストを変換」ボタン、キャンセル
  - 出力テキスト表示、コピー、閉じる
- **オプション**
  - Gemini APIキー入力/保存
  - 既定モード、既定学年レベル、温度（0.0–1.0、既定0.2）
- **ショートカット/コンテキストメニュー**
  - 任意（次版）。

### 3. アーキテクチャ（MVP）

- **構成**: `background`（Service Worker）/ `content`（選択取得）/ `popup`（操作）/ `options`（設定）/ `api/gemini`。
- **メッセージフロー**: content → background（{mode, level, text}）→ Gemini → background → popup/content。
- **チャンク分割**: 500〜700文字/チャンクで順次処理（並列なし）。
- **エラーハンドリング**: 認証/レート/長文超過/未知エラーを分類しメッセージ表示、指数バックオフで最大2回リトライ。

### 4. Gemini API 仕様（MVP）

- **エンドポイント**: `https://generativelanguage.googleapis.com/v1/models/gemini-1.5-pro:generateContent`
- **認証**: `x-goog-api-key: <API_KEY>`
- **リクエスト**（概形）:

```json
{
  "contents": [{
    "parts": [{ "text": "<プロンプト+入力テキスト>" }]
  }],
  "generationConfig": { "temperature": 0.2, "topP": 0.8, "topK": 40 }
}
```

- **レスポンス抽出**: `candidates[0].content.parts[0].text` を優先。
- **プロンプト方針**: 事実の追加禁止、固有名詞/数値の保持、意味保持最優先。学年モードは文長/語彙制約を反映。

### 5. データ/設定（MVP）

- **apiProvider**: 固定 "gemini"
- **model**: 固定 "gemini-1.5-pro"
- **temperature**: 0.0–1.0（既定0.2）
- **defaultMode**: 初期値は「簡素化」
- **gradeLevel**: 小/中/高（既定: 中）
- **outputView**: "single" 固定（任意で "side-by-side" を次版）
- **streaming**: false 固定

### 6. 変換モード（MVP詳細）

- **簡素化**: 専門用語→平易語、文の短縮、重要語の保持。
- **具体化**: 例/手順/数値目安を付す（推定は「例」と明示）。
- **抽象化**: 本質/共通構造に一般化、冗長な固有例は最小化。
- **学年**: 小≤25字/文、中≤35字/文、高≤45字/文を目安。

### 7. エラー/失敗時（MVP）

- **分類**: 認証エラー（APIキーなし/不正）/ レート制限 / ネットワーク / 長文超過 / 不明。
- **動作**: 明確な文言表示、再試行リンク、最大2回自動リトライ、入力の短縮提案。

### 8. 非機能要件（MVP）

- **レイテンシ**: 500字以下で P50 ≤ 4s, P95 ≤ 10s。
- **プライバシ**: 入出力を保存しない。APIキーのみ `chrome.storage` に保存。
- **互換性**: Chrome 120+、Manifest V3。

### 9. 受け入れ基準（MVP）

- 選択テキストに対し、4モードの変換が実行できる。
- 重要語（固有名詞・数値）の保持率 ≥ 99%。
- 学年モードで文長目安に収まる（±20%許容）。
- エラー時に原因区分と再試行が提示される。
- オプションでAPIキーを保存/更新できる。

### 10. 実装項目（MVP）

- `options` に Gemini APIキー保存UIと検証を実装。
- `popup` にモード/学年選択と実行/キャンセル/コピーを実装。
- `content` で選択テキスト取得、長文はチャンク化（順次実行）。
- `background` で Gemini呼び出し、リトライ/エラー分類、結果返却。
- `api/gemini` に `transform({ text, mode, level, temperature })` の統一IFを用意（内部でプロンプト切替）。
- 権限: "activeTab", "scripting", "storage" を `manifest.json` に定義。
